<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app" class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Inventory Management System</h1>
        <div v-if="!isAuthenticated">
            <register-component @login="handleLogin"></register-component>
            <login-component @login="handleLogin"></login-component>
        </div>
        <div v-else>
            <product-list-component @edit="editProduct" @delete="deleteProduct"></product-list-component>
            <add-product-component @product-added="fetchProducts"></add-product-component>
            <edit-product-component v-if="showEditModal" :product="editProductData" @update="updateProduct" @close="showEditModal = false"></edit-product-component>
        </div>
    </div>

    <script type="module">
        import RegisterComponent from './components/RegisterComponent.js';
        import LoginComponent from './components/LoginComponent.js';
        import ProductListComponent from './components/ProductListComponent.js';
        import AddProductComponent from './components/AddProductComponent.js';
        import EditProductComponent from './components/EditProductComponent.js';

        const { createApp } = Vue;

        createApp({
            components: {
                'register-component': RegisterComponent,
                'login-component': LoginComponent,
                'product-list-component': ProductListComponent,
                'add-product-component': AddProductComponent,
                'edit-product-component': EditProductComponent
            },
            data() {
                return {
                    isAuthenticated: !!localStorage.getItem('token'),
                    editProductData: {},
                    showEditModal: false
                };
            },
            methods: {
                handleLogin() {
                    this.isAuthenticated = true;
                    this.fetchProducts();
                },
                async fetchProducts() {
                    try {
                        const response = await fetch('/api/products', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        });
                        const products = await response.json();
                        this.$refs.productListComponent.setProducts(products);
                    } catch (error) {
                        console.error('Error fetching products:', error);
                    }
                },
                editProduct(product) {
                    this.editProductData = { ...product };
                    this.showEditModal = true;
                },
                async updateProduct(updatedProduct) {
                    try {
                        const response = await fetch(`/api/products/${updatedProduct.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(updatedProduct)
                        });
                        const data = await response.json();
                        alert(data.message || data.error);
                        this.showEditModal = false;
                        this.fetchProducts();
                    } catch (error) {
                        alert('Error: ' + error.message);
                    }
                },
                async deleteProduct(id) {
                    if (confirm('Are you sure you want to delete this product?')) {
                        try {
                            const response = await fetch(`/api/products/${id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                            });
                            const data = await response.json();
                            alert(data.message || data.error);
                            this.fetchProducts();
                        } catch (error) {
                            alert('Error: ' + error.message);
                        }
                    }
                }
            },
            mounted() {
                if (this.isAuthenticated) {
                    this.fetchProducts();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>